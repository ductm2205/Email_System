<%- include('layout', { user }) %>

    <div class="inbox-container">
        <h1>Inbox</h1>

        <div class="email-list">
            <% if (emails.length===0) { %>
                <p>No emails in your inbox.</p>
                <% } else { %>
                    <form id="deleteForm">
                        <% emails.forEach(email=> { %>
                            <div class="email-item">
                                <input type="checkbox" name="emailIds" value="<%= email.id %>" class="email-checkbox">
                                <div class="email-content">
                                    <div class="email-sender">
                                        <%= email.sender_name %>
                                    </div>
                                    <a href="/email/<%= email.id %>" class="email-subject">
                                        <%= email.subject || '(no subject)' %>
                                    </a>
                                    <div class="email-date">
                                        <%= new Date(email.created_at).toLocaleString() %>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                    </form>

                    <button id="deleteButton" class="delete-btn">Delete Selected</button>
                    <% } %>
        </div>

        <div class="pagination">
            <% for(let i=1; i <=totalPages; i++) { %>
                <a href="/inbox?page=<%= i %>" class="<%= currentPage === i ? 'active' : '' %>">
                    <%= i %>
                </a>
                <% } %>
        </div>
    </div>

    <script>
        document.getElementById('deleteButton')?.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('input[name="emailIds"]:checked');
            const emailIds = Array.from(checkboxes).map(cb => cb.value);

            if (emailIds.length === 0) return;

            try {
                const response = await fetch('/api/emails/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ emailIds }),
                });

                if (response.ok) {
                    // Remove deleted emails from the DOM
                    emailIds.forEach(id => {
                        const emailItem = document.querySelector(`input[value="${id}"]`).closest('.email-item');
                        emailItem.remove();
                    });
                } else {
                    alert('Failed to delete emails');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting emails');
            }
        });
    </script>